<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Define properties -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="foodflow"/>
    <property name="LOG_PATH" value="logs"/>
    <property name="LOG_FILE" value="${LOG_PATH}/application.log"/>
    <property name="LOG_ARCHIVE" value="${LOG_PATH}/archive/application"/>
    
    <!-- Console Appender for Development (Colored Output) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%thread] %cyan(%logger{36}) [%X{correlationId}] [%X{userId}] - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- File Appender for Production (Plain Text) -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} [correlationId=%X{correlationId}] [userId=%X{userId}] [ip=%X{ipAddress}] - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
        
        <!-- Rolling Policy: Daily rotation, max 100MB per file, keep 30 days -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_ARCHIVE}-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- JSON Appender for Log Aggregation (ELK/Loki) -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/application-json.log</file>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>correlationId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>ipAddress</includeMdcKeyName>
            <includeMdcKeyName>requestPath</includeMdcKeyName>
            <includeMdcKeyName>requestMethod</includeMdcKeyName>
            <customFields>{"application":"${APP_NAME}"}</customFields>
        </encoder>
        
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/archive/application-json-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- Async Appender for better performance -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <appender-ref ref="FILE"/>
    </appender>

    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <queueSize>512</queueSize>
        <appender-ref ref="JSON_FILE"/>
    </appender>

    <!-- Development Profile -->
    <springProfile name="dev,default">
        <!-- Application packages - DEBUG level for detailed logging -->
        <logger name="com.example.foodflow" level="DEBUG"/>
        
        <!-- Spring Framework - INFO level -->
        <logger name="org.springframework" level="INFO"/>
        <logger name="org.springframework.web" level="DEBUG"/>
        <logger name="org.springframework.security" level="DEBUG"/>
        
        <!-- Database/JPA - DEBUG to see queries -->
        <logger name="org.hibernate.SQL" level="DEBUG"/>
        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>
        <logger name="org.flywaydb" level="INFO"/>
        
        <!-- External libraries - WARN level -->
        <logger name="io.jsonwebtoken" level="INFO"/>
        <logger name="org.postgresql" level="WARN"/>
        
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
        </root>
    </springProfile>

    <!-- Production Profile -->
    <springProfile name="prod">
        <!-- Application packages - INFO level for production -->
        <logger name="com.example.foodflow" level="INFO"/>
        
        <!-- Spring Framework - WARN level -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.springframework.web" level="INFO"/>
        <logger name="org.springframework.security" level="INFO"/>
        
        <!-- Database/JPA - WARN level (don't log queries in prod) -->
        <logger name="org.hibernate.SQL" level="WARN"/>
        <logger name="org.hibernate.type" level="WARN"/>
        <logger name="org.flywaydb" level="INFO"/>
        
        <!-- External libraries - ERROR level -->
        <logger name="io.jsonwebtoken" level="WARN"/>
        <logger name="org.postgresql" level="ERROR"/>
        
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_JSON"/>
        </root>
    </springProfile>

    <!-- Test Profile -->
    <springProfile name="test">
        <!-- Minimal logging for tests -->
        <logger name="com.example.foodflow" level="INFO"/>
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.hibernate" level="WARN"/>
        
        <root level="WARN">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

</configuration>
