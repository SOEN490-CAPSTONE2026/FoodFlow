name: Weekly Coverage Reports

on:
  push:
    branches:
      - 'main'
      - 'coverage-reports-pipeline'
  schedule:
    # Runs every Monday at 7 AM UTC
    - cron: '0 7 * * 1'
  workflow_dispatch: # allows manual runs

jobs:
  frontend-coverage:
    name: Run Frontend Coverage
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.frontend_coverage.outputs.coverage }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: ./frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Run tests with coverage
        run: npm run test:coverage
        working-directory: ./frontend

      - name: Extract coverage summary
        id: frontend_coverage
        working-directory: frontend
        run: |
          npm install cheerio
          COVERAGE=$(node <<'EOF'
            const fs = require('fs');
            const cheerio = require('cheerio');

            const html = fs.readFileSync('coverage/lcov-report/index.html', 'utf8');
            const $ = cheerio.load(html);

            let lines = '';
            $('.pad1 > .clearfix > div.fl').each((i, el) => {
              const key = $(el).find('span.quiet').text().trim();
              if (key === 'Lines') {
                lines = $(el).find('span.strong').text().trim();
              }
            });

            console.log(lines.replace('%','').trim());
          EOF
          )
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov-report/index.html

  backend-coverage:
    name: Backend Coverage
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.backend_coverage.outputs.coverage }}
    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: foodflow_db
          POSTGRES_USER: foodflow_user
          POSTGRES_PASSWORD: foodflow_password
        options: >-
          --health-cmd="pg_isready -U foodflow_user -d foodflow_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout backend code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Wait for Postgres to be ready
        run: |
          until pg_isready -h localhost -U foodflow_user -d foodflow_db; do
            echo "Waiting for Postgres..."
            sleep 5
          done

      - name: Run backend tests with coverage
        working-directory: backend
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: foodflow_db
          DB_USER: foodflow_user
          DB_PASS: foodflow_password
        run: |
          ./mvnw clean test "-Dspring.profiles.active=test" || true
          ./mvnw jacoco:report

      - name: Extract JaCoCo coverage percentage from HTML
        id: backend_coverage
        working-directory: backend
        run: |
          npm install cheerio
          COVERAGE=$(node <<'EOF'
            const fs = require('fs');
            const cheerio = require('cheerio');

            const html = fs.readFileSync('target/site/jacoco/index.html', 'utf8');
            const $ = cheerio.load(html);

            // Find total line coverage percentage in the footer
            let coverage = '';
            $('tfoot tr td.ctr2').each((i, el) => {
              const text = $(el).text().trim();
              if (text.endsWith('%')) {
                coverage = text;
              }
            });

            console.log(coverage.replace('%','').trim());
          EOF
          )
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/target/site/jacoco/index.html

  summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [frontend-coverage, backend-coverage]
    steps:
      - name: Create coverage summary
        run: |
          echo "## Weekly Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Coverage:** ${{ needs.frontend-coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Coverage:** ${{ needs.backend-coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
